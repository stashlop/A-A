<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Video Games - Arcade and Archives</title>
    <style>
        body { margin: 0; font-family: sans-serif; color: white; }
        /* search & categories */
        .store-controls { display:flex; gap:1rem; align-items:center; justify-content:space-between; margin-bottom:0.75rem; flex-wrap:wrap; }
        .search-bar { display:flex; gap:.5rem; align-items:center; flex:1; max-width:640px; }
        .search-input { flex:1; padding:.5rem .7rem; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.25); color:inherit; }
        .categories { display:flex; gap:.5rem; align-items:center; overflow:auto; padding:0.25rem 0; }
        .category-btn { padding:.4rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; font-size:.9rem; cursor:pointer; white-space:nowrap; }
        .category-btn.active { background:linear-gradient(90deg,#16a085,#30c7ec); color:#fff; border:none; }
        .results-meta { color:#cfcfcf; font-size:.95rem; margin-left:1rem; min-width:120px; text-align:right; }

        body { margin: 0; font-family: sans-serif; color: white; }
        .spline-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
        #bg-video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .main-header, .hero-section { position: relative; z-index: 2; }
        .main-header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; }
        .logo-link { display:flex; align-items:center; text-decoration:none; color:inherit; }
        .logo-text { font-size:1.25rem; font-weight:700; }
        .main-nav a { margin-left:1rem; color:inherit; text-decoration:none; font-weight:600; }
        .hero-section { display:flex; justify-content:center; align-items:center; height:45vh; }
        .hero-content { text-align:center; max-width:900px; padding:1rem; }
        .hero-text h1 { font-size:3rem; margin-bottom:1rem; }
        .hero-text p { font-size:1.1rem; margin-bottom:1.25rem; color:#e6e6e6; }
        .hero-btn { padding:0.9rem 1.6rem; margin:0 0.4rem; text-decoration:none; color:white; border:1px solid rgba(255,255,255,0.18); border-radius:6px; background:rgba(0,0,0,0.25); }

        /* audio toggle */
        #audio-toggle { background:rgba(0,0,0,0.45); color:#fff; border:1px solid rgba(255,255,255,0.12); padding:0.4rem 0.6rem; border-radius:6px; cursor:pointer; font-size:1rem; margin-left:1rem; }
        #audio-toggle[aria-pressed="true"] { background:linear-gradient(90deg,#9d4edd,#f72585); box-shadow:0 2px 8px #0004; }

        /* store */
        .games-container { position:relative; z-index:3; max-width:1100px; margin:1.5rem auto 3rem; padding:1rem; }
        .store-panel { background:rgba(0,0,0,0.45); border-radius:12px; padding:1rem; box-shadow:0 8px 24px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04); overflow:auto; max-height:55vh; }
        .games-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-top:1rem; }
        .game-card { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); padding:0.8rem; border-radius:10px; color:#fff; }
        .game-card img { width:100%; height:140px; object-fit:cover; border-radius:6px; display:block; margin-bottom:0.6rem; }
        .game-card h3 { margin:0 0 0.3rem 0; font-size:1.05rem; }
        .game-desc { margin:0 0 0.6rem 0; color:#e6e6e6; font-size:.95rem; }
        .game-actions { display:flex; gap:0.5rem; justify-content:center; }
        .game-actions button { padding:0.45rem 0.7rem; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
        .buy-btn { background:linear-gradient(90deg,#16a085,#30c7ec); color:#fff; }
        .rent-btn { background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.06); }

        /* cart modal */
        #cart-modal { position:fixed; right:1rem; top:4rem; background:rgba(0,0,0,0.85); color:#fff; padding:1rem; border-radius:8px; display:none; z-index:5000; min-width:260px; }
        #cart-items { margin:0.5rem 0; padding-left:1rem; max-height:40vh; overflow:auto; }
        #cart-modal button { padding:0.4rem 0.6rem; border-radius:6px; border:none; cursor:pointer; }

        /* history modal */
        #history-modal { position:fixed; right:1rem; top:4rem; background:rgba(0,0,0,0.85); color:#fff; padding:1rem; border-radius:8px; display:none; z-index:5000; min-width:320px; }
        #history-items { margin:0.5rem 0; padding-left:1rem; max-height:40vh; overflow:auto; }

        /* payment modal */
        #payment-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:360px; max-width:calc(100% - 2rem); background:rgba(8,8,8,0.95); color:#fff; border-radius:10px; padding:1rem; box-shadow:0 10px 40px rgba(0,0,0,0.6); z-index:6000; display:none; }
        #payment-modal header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
        #payment-modal label { display:block; font-size:0.9rem; margin-top:0.6rem; color:#e6e6e6; }
        #payment-modal input[type="text"], #payment-modal input[type="email"], #payment-modal input[type="tel"], #payment-modal select { width:100%; padding:0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:inherit; margin-top:0.25rem; }
        #payment-modal .row { display:flex; gap:0.5rem; }
        #payment-modal .muted { font-size:0.85rem; color:#cfcfcf; margin-top:0.4rem; }
        #payment-modal .pay-actions { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.75rem; }
        #payment-modal .btn { padding:0.5rem 0.6rem; border-radius:6px; border:none; cursor:pointer; }
        #payment-modal .btn.primary { background:linear-gradient(90deg,#16a085,#30c7ec); color:#fff; }
        #payment-modal .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#fff; }

        .processing { opacity:0.6; pointer-events:none; }
    </style>
</head>
<body class="antialiased">

    <div class="spline-background">
        <video id="bg-video" autoplay loop muted playsinline>
            <source src="{{ url_for('static', filename='videogames.mp4') }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <!-- corrected audio source -->
        <audio id="bg-audio" loop preload="auto">
            <source src="{{ url_for('static', filename='videogames.mp4') }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>

    <header class="main-header">
        <a href="{{ url_for('home') }}" class="logo-link"><span class="logo-text">Arcade and Archives</span></a>
        <nav class="main-nav">
            <a href="{{ url_for('home') }}">Home</a>
            <a href="{{ url_for('books') }}">Books</a>
            <a href="{{ url_for('video_games') }}">Video Games</a>
            <a href="{{ url_for('cafe') }}">Cafe</a>

            <!-- new: purchase history & header cart -->
            <button id="history-btn" title="Purchase history" style="margin-left:0.8rem; background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:0.4rem 0.6rem; border-radius:6px; cursor:pointer;">History</button>
            <button id="header-view-cart" title="View cart" style="margin-left:0.6rem; background:linear-gradient(90deg,#16a085,#30c7ec); color:#fff; padding:0.4rem 0.6rem; border-radius:6px; border:none; cursor:pointer;">
                Cart (<span id="header-cart-count">0</span>)
            </button>

            <button id="audio-toggle" aria-pressed="false" title="Toggle sound">ðŸ”ˆ</button>
        </nav>
    </header>

    <main class="hero-section">
        <div class="hero-content">
            <div class="hero-text">
                <h1>Arcade Vault</h1>
                <p>Dive into retro cabinets and modern delights. Play demos, view high scores, or learn about classic titles.</p>
                <a class="hero-btn" href="{{ url_for('video_games') }}">Explore Games</a>
                <a class="hero-btn" href="{{ url_for('home') }}">Back Home</a>
            </div>
        </div>
    </main>

    <div class="games-container">
        <div class="store-panel">
            <section class="explore-store" aria-label="Explore Games">
                <h2 style="margin-top:0;">Explore & Shop</h2>
                <div class="games-grid">
                    <!-- store controls: search + categories -->
                    <div class="store-controls" style="grid-column:1/-1;">
                        <div class="search-bar" role="search" aria-label="Search games">
                            <input id="search-input" class="search-input" type="search" placeholder="Search games, genres, keywords (e.g. 'RPG', 'horror')">
                            <button id="clear-search" class="category-btn" title="Clear search">Clear</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:.5rem">
                            <div id="categories" class="categories" aria-label="Categories"></div>
                            <div id="results-meta" class="results-meta" aria-hidden="true"></div>
                        </div>
                    </div>
                    
                    {%- for g in games %}
                    <article class="game-card" data-id="{{ g.id }}" data-title="{{ g.title }}" data-category="{{ g.category }}" data-buy="{{ '%.2f'|format(g.buy_price) }}" data-rent="{{ '%.2f'|format(g.rent_price) }}">
                        {% if g.image %}
                        <img src="{{ url_for('static', filename=g.image) }}" alt="{{ g.title }}">
                        {% endif %}
                        <h3>{{ g.title }}</h3>
                        <p class="game-desc">{{ g.description }}</p>
                        <div class="game-actions">
                            <button class="buy-btn">Buy ${{ '%.2f'|format(g.buy_price) }}</button>
                            <button class="rent-btn">Rent ${{ '%.2f'|format(g.rent_price) }}</button>
                        </div>
                    </article>
                    {%- else %}
                    <div class="card">No games available.</div>
                    {%- endfor %}
                 </div>

                <div id="cart-bar" aria-live="polite" style="margin-top:1rem;">
                    Cart: <span id="cart-count">0</span> items â€” <button id="view-cart">View</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Cart modal -->
    <div id="cart-modal" role="dialog" aria-hidden="true">
        <strong>Cart</strong>
        <ul id="cart-items"></ul>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            <button id="checkout">Checkout</button>
            <button id="close-cart">Close</button>
        </div>
    </div>

    <!-- Purchase history modal -->
    <div id="history-modal" role="dialog" aria-hidden="true" style="display:none; position:fixed; right:1rem; top:4rem; background:rgba(0,0,0,0.85); color:#fff; padding:1rem; border-radius:8px; z-index:5000; min-width:320px;">
        <strong>Purchase History</strong>
        <ul id="history-items" style="margin:0.5rem 0; padding-left:1rem; max-height:40vh; overflow:auto;"></ul>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            <button id="clear-history" style="background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:0.4rem 0.6rem; border-radius:6px; cursor:pointer;">Clear</button>
            <button id="close-history" style="background:linear-gradient(90deg,#16a085,#30c7ec); color:#fff; padding:0.4rem 0.6rem; border-radius:6px; border:none; cursor:pointer;">Close</button>
        </div>
    </div>

    <!-- Payment modal (demo client-side simulation) -->
    <div id="payment-modal" role="dialog" aria-hidden="true" aria-labelledby="payment-title">
        <header>
            <h3 id="payment-title" style="margin:0;">Checkout â€” Demo Payment</h3>
            <button id="close-payment" title="Close">âœ•</button>
        </header>

        <form id="payment-form" novalidate>
            <div class="muted">Cart total: <strong id="payment-total">$0.00</strong></div>

            <label for="payer-name">Name</label>
            <input id="payer-name" name="name" type="text" required placeholder="Jane Doe">

            <label for="payer-email">Email</label>
            <input id="payer-email" name="email" type="email" required placeholder="jane@example.com">

            <label>Payment method</label>
            <div style="display:flex; gap:.5rem; align-items:center; margin-top:.25rem;">
                <label style="font-size:.95rem;"><input type="radio" name="pm" value="card" checked> Card</label>
                <label style="font-size:.95rem;"><input type="radio" name="pm" value="demo"> Demo (no charge)</label>
            </div>

            <div id="card-fields">
                <label for="card-number">Card number</label>
                <input id="card-number" name="card" type="tel" inputmode="numeric" placeholder="4242 4242 4242 4242">

                <div class="row">
                    <div style="flex:1;">
                        <label for="card-exp">Expiry (MM/YY)</label>
                        <input id="card-exp" name="exp" type="text" placeholder="04/28">
                    </div>
                    <div style="width:110px;">
                        <label for="card-cvc">CVC</label>
                        <input id="card-cvc" name="cvc" type="text" placeholder="123">
                    </div>
                </div>
            </div>

            <div class="pay-actions">
                <button type="button" class="btn ghost" id="fill-demo">Fill demo card</button>
                <button type="submit" class="btn primary" id="pay-submit">Pay</button>
            </div>

            <div id="payment-message" class="muted" style="margin-top:.5rem"></div>
        </form>
    </div>

    <script>
        // expose login state to client scripts (Jinja)
        window.App = window.App || {};
        App.userLoggedIn = "{{ 'true' if session.get('user_id') else 'false' }}";
        App.loginUrl = "{{ url_for('login') }}";
        App.loginNextParam = function(nextPath){
            return App.loginUrl + '?next=' + encodeURIComponent(nextPath || window.location.pathname);
        };

        // disable purchase controls for anonymous users and show prompt
        function ensureAuthOrRedirect(nextPath){
            if (App.userLoggedIn !== true && App.userLoggedIn !== 'true') {
                if (confirm('You must sign in to access purchases and renting. Go to sign in now?')) {
                    window.location.href = App.loginNextParam(nextPath);
                }
                return false;
            }
            return true;
        }
        // run once: mark buttons requiring auth
        document.querySelectorAll('.buy-btn, .rent-btn').forEach(btn=>{
            // show disabled hint client-side if not logged in
            if (App.userLoggedIn !== true && App.userLoggedIn !== 'true') {
                btn.setAttribute('data-requires-auth','1');
            }
        });

        const logoLink = document.querySelector('.logo-link');
        const logoVideo = logoLink ? logoLink.querySelector('.logo-video') : null;
        if (logoLink && logoVideo) {
            logoLink.addEventListener('mouseenter', () => logoVideo.play());
            logoLink.addEventListener('mouseleave', () => { logoVideo.currentTime = 0; });
        }

        // audio controls
        const bgAudio = document.getElementById('bg-audio');
        const bgVideo = document.getElementById('bg-video');
        const audioToggle = document.getElementById('audio-toggle');

        async function tryPlayAudio() {
            if (!bgAudio) return;
            try {
                await bgAudio.play();
                audioToggle.textContent = 'ðŸ”Š';
                audioToggle.setAttribute('aria-pressed','true');
            } catch (err) {
                audioToggle.textContent = 'ðŸ”ˆ';
                audioToggle.setAttribute('aria-pressed','false');
            }
        }

        audioToggle.addEventListener('click', async () => {
            if (audioToggle.getAttribute('aria-pressed') === 'true') {
                audioToggle.setAttribute('aria-pressed', 'false');
                audioToggle.textContent = 'ðŸ”ˆ';
                bgAudio.pause();
            } else {
                audioToggle.setAttribute('aria-pressed', 'true');
                audioToggle.textContent = 'ðŸ”Š';
                await tryPlayAudio();
            }
        });

        // preload and prepare video
        bgVideo.pause();
        bgVideo.currentTime = 0.1;
        bgVideo.load();

        // Simple cart logic
        const cart = [];
        const cartCountEl = document.getElementById('cart-count');         // footer/bar count
        const headerCartCountEl = document.getElementById('header-cart-count'); // header count
        const cartItemsEl = document.getElementById('cart-items');
        const cartModal = document.getElementById('cart-modal');
        const viewCartBtn = document.getElementById('view-cart');
        const headerViewCartBtn = document.getElementById('header-view-cart');
        const closeCartBtn = document.getElementById('close-cart');
        const checkoutBtn = document.getElementById('checkout');

        // Purchase history
        const historyModal = document.getElementById('history-modal');
        const historyBtn = document.getElementById('history-btn');
        const historyItemsEl = document.getElementById('history-items');
        const closeHistoryBtn = document.getElementById('close-history');
        const clearHistoryBtn = document.getElementById('clear-history');

        function getPurchaseHistory() {
            try {
                return JSON.parse(localStorage.getItem('purchaseHistory') || '[]');
            } catch (_) { return []; }
        }
        function savePurchaseHistory(list) {
            localStorage.setItem('purchaseHistory', JSON.stringify(list || []));
        }
        function addToPurchaseHistory(purchase) {
            const list = getPurchaseHistory();
            list.unshift(purchase); // newest first
            savePurchaseHistory(list);
            renderHistoryUI();
        }
        function renderHistoryUI() {
            const list = getPurchaseHistory();
            historyItemsEl.innerHTML = '';
            if (list.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No purchases yet.';
                historyItemsEl.appendChild(li);
                return;
            }
            list.forEach(p => {
                const li = document.createElement('li');
                const date = new Date(p.date).toLocaleString();
                li.innerHTML = `<strong>${p.items.length} item(s)</strong> â€” $${p.total} â€” ${date}<br><small style="color:#cfcfcf;">${p.buyer?.name || ''} ${p.buyer?.email ? 'â€” ' + p.buyer.email : ''}</small>`;
                const details = document.createElement('ul');
                details.style.margin = '0.4rem 0 0.6rem 0.6rem';
                details.style.padding = '0';
                p.items.forEach(it => {
                    const its = document.createElement('li');
                    its.style.listStyle = 'disc';
                    its.style.color = '#e6e6e6';
                    its.textContent = `${it.title} â€” ${it.type} â€” $${it.price}`;
                    details.appendChild(its);
                });
                li.appendChild(details);
                historyItemsEl.appendChild(li);
            });
        }

        function updateCartUI() {
            if (cartCountEl) cartCountEl.textContent = cart.length;
            if (headerCartCountEl) headerCartCountEl.textContent = cart.length;
            cartItemsEl.innerHTML = '';
            cart.forEach((it, idx) => {
                const li = document.createElement('li');
                li.textContent = `${it.title} â€” ${it.type} â€” $${it.price}`;
                const rm = document.createElement('button');
                rm.textContent = 'x';
                rm.style.marginLeft = '0.6rem';
                rm.onclick = () => { cart.splice(idx,1); updateCartUI(); };
                li.appendChild(rm);
                cartItemsEl.appendChild(li);
            });
        }

        document.querySelectorAll('.buy-btn').forEach(btn=>{
            btn.addEventListener('click', e=>{
                // require auth
                if (!ensureAuthOrRedirect(window.location.pathname)) return;
                const card = e.target.closest('.game-card, .card');
                const title = card.dataset.title;
                const price = card.dataset.buy;
                cart.push({ id: card.dataset.id, title, type: 'Buy', price });
                updateCartUI();
                alert(`${title} added to cart â€” $${price}`);
            });
        });

        document.querySelectorAll('.rent-btn').forEach(btn=>{
            btn.addEventListener('click', e=>{
                // require auth
                if (!ensureAuthOrRedirect(window.location.pathname)) return;
                const card = e.target.closest('.game-card, .card');
                const title = card.dataset.title;
                const base = parseFloat(card.dataset.rent || '0');
                let days = prompt('Rent days (1,3,7):', '1');
                if (!days) return;
                days = parseInt(days,10);
                if (![1,3,7].includes(days)) { alert('Choose 1,3 or 7 days'); return; }
                const price = (base * days).toFixed(2);
                cart.push({ id: card.dataset.id, title, type: `Rent ${days}d`, price });
                updateCartUI();
                alert(`${title} added to cart (Rent ${days}d â€” $${price})`);
            });
        });

        // wire header cart button to show cart modal
        if (headerViewCartBtn) {
            headerViewCartBtn.addEventListener('click', () => {
                cartModal.style.display = 'block';
                cartModal.setAttribute('aria-hidden','false');
            });
        }

        if (viewCartBtn) {
            viewCartBtn.addEventListener('click', () => {
                cartModal.style.display = 'block';
                cartModal.setAttribute('aria-hidden','false');
            });
        }

        closeCartBtn.addEventListener('click', () => {
            cartModal.style.display = 'none';
            cartModal.setAttribute('aria-hidden','true');
        });

        // replaced checkout behavior: open payment modal
        const paymentModal = document.getElementById('payment-modal');
        const paymentForm = document.getElementById('payment-form');
        const payTotal = document.getElementById('payment-total');
        const paymentMessage = document.getElementById('payment-message');
        const closePaymentBtn = document.getElementById('close-payment');
        const fillDemoBtn = document.getElementById('fill-demo');
        const cardFields = document.getElementById('card-fields');

        function cartTotal() {
            return cart.reduce((s,i)=> s + parseFloat(i.price), 0).toFixed(2);
        }

        function openPaymentModal() {
            payTotal.textContent = `$${cartTotal()}`;
            paymentMessage.textContent = '';
            paymentForm.classList.remove('processing');
            paymentModal.style.display = 'block';
            paymentModal.setAttribute('aria-hidden','false');
            // show/hide card fields based on selection
            const sel = paymentForm.querySelector('input[name="pm"]:checked').value;
            cardFields.style.display = sel === 'demo' ? 'none' : 'block';
        }

        function closePaymentModal() {
            paymentModal.style.display = 'none';
            paymentModal.setAttribute('aria-hidden','true');
        }

        checkoutBtn.addEventListener('click', () => {
            if (cart.length === 0) { alert('Cart is empty'); return; }
            // open payment modal
            openPaymentModal();
        });

        closePaymentBtn.addEventListener('click', () => closePaymentModal());

        // toggle card fields when payment method changes
        paymentForm.querySelectorAll('input[name="pm"]').forEach(r => {
            r.addEventListener('change', (e) => {
                cardFields.style.display = e.target.value === 'demo' ? 'none' : 'block';
            });
        });

        // prefill demo card values
        fillDemoBtn.addEventListener('click', () => {
            document.getElementById('card-number').value = '4242 4242 4242 4242';
            document.getElementById('card-exp').value = '12/29';
            document.getElementById('card-cvc').value = '123';
            document.getElementById('payer-name').focus();
            paymentMessage.textContent = 'Demo card filled. Select Demo to avoid real processing.';
        });

        // simple client-side validation and demo processing
        paymentForm.addEventListener('submit', (ev) => {
            ev.preventDefault();
            paymentMessage.textContent = '';
            const name = document.getElementById('payer-name').value.trim();
            const email = document.getElementById('payer-email').value.trim();
            const pm = paymentForm.querySelector('input[name="pm"]:checked').value;

            if (!name || !email) {
                paymentMessage.textContent = 'Name and email are required.';
                return;
            }

            // prepare purchase snapshot for history (use before clearing cart)
            const purchaseSnapshot = {
                id: Date.now(),
                items: cart.map(i => ({ ...i })),
                total: cartTotal(),
                buyer: { name, email },
                date: new Date().toISOString()
            };

            if (pm === 'demo') {
                // demo flow: no real charge
                paymentMessage.textContent = 'Processing demo payment...';
                paymentForm.classList.add('processing');
                setTimeout(() => {
                    paymentMessage.textContent = 'Demo payment successful. Thank you!';
                    addToPurchaseHistory(purchaseSnapshot);
                    cart.length = 0;
                    updateCartUI();
                    paymentForm.classList.remove('processing');
                    setTimeout(() => { closePaymentModal(); cartModal.style.display = 'none'; }, 900);
                }, 1000);
                return;
            }

            // card flow (simulated): basic checks
            const card = document.getElementById('card-number').value.replace(/\s+/g,'');
            const exp = document.getElementById('card-exp').value.trim();
            const cvc = document.getElementById('card-cvc').value.trim();

            if (!/^\d{15,19}$/.test(card)) {
                paymentMessage.textContent = 'Enter a valid card number (digits only).';
                return;
            }
            if (!/^\d{2}\/\d{2}$/.test(exp)) {
                paymentMessage.textContent = 'Expiry must be MM/YY.';
                return;
            }
            if (!/^\d{3,4}$/.test(cvc)) {
                paymentMessage.textContent = 'CVC must be 3 or 4 digits.';
                return;
            }

            // simulated processing
            paymentMessage.textContent = 'Processing payment...';
            paymentForm.classList.add('processing');
            setTimeout(() => {
                // accept demo test card 4242... or randomly succeed
                if (card.startsWith('4242') || Math.random() > 0.1) {
                    paymentMessage.textContent = 'Payment successful. Thank you!';
                    addToPurchaseHistory(purchaseSnapshot);
                    cart.length = 0;
                    updateCartUI();
                    paymentForm.classList.remove('processing');
                    setTimeout(() => { closePaymentModal(); cartModal.style.display = 'none'; }, 900);
                } else {
                    paymentMessage.textContent = 'Payment failed. Try another card or choose Demo.';
                    paymentForm.classList.remove('processing');
                }
            }, 1400);
        });

        // categories + search for games
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        const categoriesEl = document.getElementById('categories');
        const resultsMeta = document.getElementById('results-meta');
        const gameCards = Array.from(document.querySelectorAll('.game-card'));

        function buildCategories() {
            const cats = new Set();
            gameCards.forEach(c => {
                const v = (c.dataset.category || '').split(',').map(s=>s.trim()).filter(Boolean);
                v.forEach(x => cats.add(x));
            });
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All';
            allBtn.className = 'category-btn active';
            allBtn.dataset.cat = '';
            categoriesEl.appendChild(allBtn);
            Array.from(cats).sort().forEach(cat => {
                const b = document.createElement('button');
                b.textContent = cat;
                b.className = 'category-btn';
                b.dataset.cat = cat;
                categoriesEl.appendChild(b);
            });
        }

        let activeCategory = '';
        function setActiveCategory(catBtn) {
            Array.from(categoriesEl.children).forEach(b => b.classList.remove('active'));
            if (catBtn) {
                catBtn.classList.add('active');
                activeCategory = catBtn.dataset.cat || '';
            } else {
                activeCategory = '';
            }
            applyFilters();
        }

        function applyFilters() {
            const q = (searchInput?.value || '').trim().toLowerCase();
            let visible = 0;
            gameCards.forEach(card => {
                const title = (card.dataset.title || '').toLowerCase();
                const desc = (card.querySelector('.game-desc')?.textContent || '').toLowerCase();
                const cats = (card.dataset.category || '').toLowerCase();
                const matchesQuery = !q || title.includes(q) || desc.includes(q) || cats.includes(q);
                const matchesCat = !activeCategory || cats.split(',').map(s=>s.trim()).includes(activeCategory.toLowerCase());
                const show = matchesQuery && matchesCat;
                card.style.display = show ? '' : 'none';
                if (show) visible++;
            });
            resultsMeta.textContent = `${visible} / ${gameCards.length}`;
        }

        // debounce helper
        function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

        // build controls
        buildCategories();
        categoriesEl.addEventListener('click', (e)=> {
            const b = e.target.closest('.category-btn');
            if (!b) return;
            // toggle "All" or select specific
            if (b.dataset.cat === '') {
                setActiveCategory(b);
            } else {
                setActiveCategory(b);
            }
        });

        searchInput?.addEventListener('input', debounce(()=> applyFilters(), 300));
        clearSearchBtn?.addEventListener('click', ()=> { if (searchInput) { searchInput.value=''; applyFilters(); searchInput.focus(); } });
        // initial filter state
        applyFilters();
        // visually disable purchase controls if anonymous
        if (App.userLoggedIn !== true && App.userLoggedIn !== 'true') {
            document.querySelectorAll('[data-requires-auth]').forEach(b => {
                b.style.opacity = '0.7';
                b.title = 'Sign in required';
            });
        }

        // history modal handlers
        if (historyBtn) {
            historyBtn.addEventListener('click', () => {
                renderHistoryUI();
                historyModal.style.display = 'block';
                historyModal.setAttribute('aria-hidden','false');
            });
        }
        if (closeHistoryBtn) {
            closeHistoryBtn.addEventListener('click', () => {
                historyModal.style.display = 'none';
                historyModal.setAttribute('aria-hidden','true');
            });
        }
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', () => {
                if (!confirm('Clear all purchase history?')) return;
                savePurchaseHistory([]);
                renderHistoryUI();
            });
        }

        // initial UI update
        updateCartUI();
        renderHistoryUI();

        // try to autoplay audio after user interaction
        window.addEventListener('pointerdown', function once() {
            tryPlayAudio();
            window.removeEventListener('pointerdown', once);
        });
    </script>
</body>
</html>